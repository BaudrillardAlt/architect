#!/bin/sh
set -eu

FIREFOX_DIR="$HOME/.mozilla/firefox"
USB_LABEL_DEV="/dev/disk/by-label/linux-usb"
USB_MOUNT="/mnt/usb"

# Check USB mount
if ! mountpoint -q "$USB_MOUNT"; then
  echo "$USB_MOUNT is not mounted. Attempting to mount $USB_LABEL_DEV..."
  if ! mount "$USB_LABEL_DEV" "$USB_MOUNT"; then
    echo "Failed to mount $USB_LABEL_DEV at $USB_MOUNT"
    exit 1
  fi
fi

# Use the specific Firefox profile folder
profile="$FIREFOX_DIR/jl1ucoi1.default-nightly"
if [ ! -e "$profile" ]; then
  echo "Profile jl1ucoi1.default-nightly not found in $FIREFOX_DIR"
  echo "Available profiles:"
  ls -la "$FIREFOX_DIR"
  exit 1
fi

basename=$(basename "$profile")
echo "Found profile: $basename"

# Check if it's a symlink and show the target
if [ -L "$profile" ]; then
  target=$(readlink "$profile")
  echo "Profile is a symlink pointing to: $target"
  profile="$target"
fi

echo "Copying $basename to $USB_MOUNT using rsync..."
rsync -a --delete "$profile/" "$USB_MOUNT/$basename/"
echo "Done."
